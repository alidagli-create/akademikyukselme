// TAM GÜNCELLENMİŞ buildWordHTML FONKSİYONU
const buildWordHTML = (reportTitle, reportYokId, batchData, fullData, isFirstPart) => {

    // Görselleri tek parça, orantılı küçültülmüş şekilde gösteren fonksiyon
    const getImageTag = (imgData) => {
        if (!imgData || !imgData.base64) return '<p>[Görsel işlenemedi]</p>';
        return `
            <div style="
                display:flex; 
                justify-content:center; 
                align-items:center; 
                width:100%; 
                max-height:750px; 
                overflow:hidden; 
                margin:0.5rem 0; 
                page-break-inside:avoid;
            ">
                <img 
                    src="data:image/jpeg;base64,${imgData.base64}" 
                    style="
                        max-width:100%;
                        max-height:100%;
                        height:auto;
                        width:auto;
                        object-fit:contain;
                        display:block;
                    " 
                    alt="image"
                >
            </div>
        `;
    };

    // Başlık + görselleri aynı sayfada tutan sayfa yapısı
    const createPage = (captionHtml, imagesHtml) => {
        return `
            <div class="page">
                ${captionHtml ? `<h4 class="caption">${captionHtml}</h4>` : ''}
                ${imagesHtml}
            </div>
        `;
    };

    // HTML başlat
    let htmlParts = [];
    htmlParts.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><style>');
    htmlParts.push(`
        * { font-family: "Times New Roman", serif; }
        body { margin: 0; padding: 0; }
        .page { 
            page-break-after: always; 
            break-after: page; 
            page-break-inside: avoid; 
            -webkit-region-break-inside: avoid;
            padding: 2cm;
        }
        .caption { 
            font-size: 12pt; 
            font-weight: bold; 
            margin: 0.4rem 0 0.6rem 0; 
            text-align: center;
        }
        h1.cover { 
            font-size: 20pt; 
            font-weight: bold; 
            margin-bottom: 0.4rem; 
            text-align: center;
        }
        p.meta { 
            font-size: 11pt; 
            margin: 0.2rem 0 0.8rem 0; 
            text-align: center;
        }
        ol.toc { 
            font-size: 11pt; 
            margin-top: 1rem; 
        }
        img { 
            page-break-inside: avoid; 
            break-inside: avoid; 
            max-width:100%; 
            height:auto; 
            display:block; 
        }
    `);
    htmlParts.push('</style></head><body>');

    // KAPAK SAYFASI (sadece ilk partta)
    if (isFirstPart) {
        let toc = '<ol class="toc">';
        fullData.forEach(d => {
            const safeTitle = (d.title || '').toString().replace(/</g, '&lt;').replace(/>/g, '&gt;');
            toc += `<li>${safeTitle}</li>`;
        });
        toc += '</ol>';

        htmlParts.push(`
            <div class="page">
                <div style="text-align:center;">
                    <h1 class="cover">${reportTitle}</h1>
                    <p class="meta">YÖK ID: ${reportYokId || ''}</p>
                    <h2 style="font-size:14pt; margin-top:1rem;">Atıflar</h2>
                    ${toc}
                </div>
            </div>
        `);
    }

    // HER ATIF İÇİN SAYFALAR OLUŞTUR
    batchData.forEach((data) => {
        const idx = data.originalIndex + 1;

        // 1) Yayının Ünvan Sayfası
        const unvanCaption = `Atıf ${idx} — A${idx}. Yayının Ünvan Sayfası`;
        const unvanImageHtml = getImageTag(data.unvanImg);
        htmlParts.push(createPage(unvanCaption, unvanImageHtml));

        // 2) Eserin Başlık Sayfası
        const baslikCaption = `A${idx}. Eserin Başlık Sayfası`;
        const baslikImageHtml = getImageTag(data.baslikImg);
        htmlParts.push(createPage(baslikCaption, baslikImageHtml));

        // 3) Eserde İlk Atıf Yapılan Sayfa(lar)
        const atifCaption = `A${idx}. Eserde İlk Atıf Yapılan Sayfa(lar)`;
        let atifImagesHtml = '';
        if (Array.isArray(data.atifImgs) && data.atifImgs.length > 0) {
            data.atifImgs.forEach(img => { atifImagesHtml += getImageTag(img); });
        } else {
            atifImagesHtml = '<p>[İlgili atıf görsel(leri) yok]</p>';
        }
        htmlParts.push(createPage(atifCaption, atifImagesHtml));

        // 4) Kaynakça Sayfası(lar)
        const kaynakCaption = `A${idx}. Kaynakça Sayfası`;
        let kaynakImagesHtml = '';
        if (Array.isArray(data.kaynakcaImgs) && data.kaynakcaImgs.length > 0) {
            data.kaynakcaImgs.forEach(img => { kaynakImagesHtml += getImageTag(img); });
        } else {
            kaynakImagesHtml = '<p>[Kaynakça görsel(leri) yok]</p>';
        }
        htmlParts.push(createPage(kaynakCaption, kaynakImagesHtml));
    });

    // HTML bitir
    htmlParts.push('</body></html>');
    return htmlParts.join('');
};
